# 제 6장 파티셔닝 


파티셔닝의 목적은

1. 핫스팟(불균형적으로 높은 부하를 받는 노드)이 생기지 않게 하고 
2. 데이터와 질의부하를 여러장비에 균일하게 분배 하는 것

입니다. 

데이터에 적합한 파티셔닝 방법과 클러스터에 노드의 변화에 따라 파티션 재균화를 실행하는 것은 중요한 이슈입니다.

데이터 베이스에 읽기 , 쓰기 문제는 trade-off의 관계입니다. 데이터 베이스를 변화하고 파티셔닝하는 순간에도 이는 고려되어야하는 부분입니다. 

저장하고 처리할 데이터가 많아서 장비한대로 처리하기 힘들다면 분산해야하는데 

이때 단일노드의 구성에서 읽고 쓰고 하던 부분이 분산으로 처리된다면 

- 데이터를 분산하여 저장하는 기준이 정해져야하고 

- 분산된 데이터를 질의하여 처리하 index에 대해 고민해야하며 

- 마지막으로 이 분산된 데이터의 위치에 접근하는 이슈를 

처리하고 알아야합니다. 

따라 아래에 책에 나온 방법을 기술합니다. 


## 키-값 데이터 파티셔닝 
 

- 키범위 파티셔닝 
  - 키가 정렬되어있으며  개별파티션은 (ex)사전) 처럼 범위의 경계를 가지고 노드를 나눕니다. 
  - 특정 노드에 있어 분리된 범위를 알기 쉬워 저장시 특정 노드에 대해서 찾기 쉽습니다. 

![키 값 데이터 파티셔닝](https://i.imgur.com/tn4v1Tu.png)



- 해시파티셔닝
  -  위 키 범위 파티셔닝에서 쓰기와 읽기가 동시 에 몰린 노드의 상황을 생각해보자 
  -  해시함수를 사용해서 쏠린 데이터를 입력으로 받아 아래그림처럼 균일분산을 노려본다고하자 
  -  이때 해시함수는 암호학적으로 강력한게 핵심이 아닌 '균일하게 분산한다' 의 개념을 상기하자 
  -  해시값을 기준으로 균등하게 분배되었다면 그 균일하게 분배된 키를 그 해시값의 범주에 기록하면 된다. 
  -  (일관성 해싱에 대해서는 재균형화 부분의 내용을 보도록하자)

![해시파티셔닝 ](https://i.imgur.com/LtzTpUL.png)


- 키범위 파티셔닝 
  - 범위 질의가  효율적이다. 
  - 특정 노드에 대한 즉 범위가 같은 부분의 스캔이 어플리케이션에서 질의된다면 이는 핫스팟을 유발할 수 있다. 
  - 쓰기연산과 질의 연산이 한 노드에 집중된다면 이문제를 효율적으로 해결할 수 없다. 



- 해시파티셔닝 
  - 범위질의의 효율성이 사라진다. 정렬순서가 유지되지않기때문이다
  - 이때 데이터베이스별로 이를 중간에서 타협하는 구조로 키의 첫부분만 해싱을 적용하고 남은칼럼은 ss 테이블에서 데이터를정렬하는 연쇄 색인을 사용할수있다( 카산드라 db)



이런 파티셔닝은 쏠린작업부하와 핫스팟을 완화하기 위해서 진행된다. 

만약 이런상황에서도 부하가 걸린다면 결국 그 id의 해시값은 동일 하거나 키값은 동일하기 때문에 이를 위해서 키의 시작이나 끝에 임의의 숫자를 붙이는 것으로 분산하기도한다. 

그러나 이렇게 다른 키에 쪼개서 쓰면 쓰기와 읽기 실행시 추가적은 작업이 필요해지기 때문에 파티셔닝 기법의 트레이드 오프관계를 꼼꼼히 따져보아야한다. 

## 파티셔닝 보조색인

기본키만을 이용한 데이터모델은 유일하게 식별하는 용도의 개념이지만 보조색인의 용도는 특정한 값이 발생한 항목을 검색하는 수단이다.  게시판에서 필러링기능등등의 구현에 적합하지만 데이터베이스의 구성복잡도가 올라가는 단점이 있다. 

 파티션에 보조색인이 파티션별로 독립적으로 서로관계없이 동작하는지 여부에따라 지역색인과 전역색인으로 나뉜다. 

문서파티셔닝 색인 

- 파티션 분리시 독립적으로 분리된다. 질의를 실행할때 알맞는 파티션을 지정해 읽을 수 있다.
- 기본 문서 id 즉 primary key index의 범주를 기준으로 나누고 보조색인으로 동일한 파티션에 동일한 색인 구조를 할당한다. 
- 이때 단순히 나누는 구조이기때문에 병렬 질의를 진행할때 지역색인이라고 불린다. 
- 문서 파티셔닝 색인이 가지는 문제는 모든 파티션에 질의(스캐터/개더)를 해야하는 항목일경우 결과를 모두 모아야하는 비용문제가 발생한다. 꼬리지연시간 문제가 생길 수 있다. 

![문서(지역)색인 파티셔닝 ](https://i.imgur.com/sxUIVgG.png)



용어 파티셔닝 색인 

- 색인 자체가 파티션에 독립적이게 생성되는 것이 아니라 용어를 기준으로 하기 때문에 필터링에 적합하다.
- 문서파티셔닝과는다르게 보조색인이 기본키인덱스의 범주에 국한하여 생선되지않는다 . 기본키 색인의 파티셔닝이 아닌 보조색인은 다른식으로 색인할 수 있음을보여준다. 
- 아래와 같이 보조색인이 따로 용어를 기준으로 파티셔닝하여 문서 색인과는 다르게 기본키의 범주에 영향을 크게 받지 않고 보조색인의 독립적인 파티셔닝 기준이 생성될 수 있다. 
- 전역보조색인은 비동기 대개 비동기 갱신이기때문에 반영에 시간이 걸릴 수 있다. 

![용어(전역)색인 파티셔닝](https://i.imgur.com/CSqnU9S.png)

## 파티션 재균형화 

파티션 재균형화는 위와같이 키값 데이터 파티셔닝과 파티셔닝의 보조색인이 진행된 후에도 시간이 지남에 따라 데이터베이스의 변화에 의하여 그 필요가 산정된다. 

1. 질의 처리량의 증가에 따라 cpu를 추가한다
2. 데이터셋의 크기가 증가해서 저장을 위한 디스크와 램을 추가한다
3. 장비에 장애가 있어 담당역할을 다른 장비가 넘겨받는다 

데이터와 요청이 한노드에서 다른노드로 옮겨져야한다 

클러스터에서 한노드가 담당하던 부하를 다른 노드로 옮겨가는과정을  재 균형화라고 한다.



파티셔닝 방식과 무관하게 재균형화 실행시 최소요구 사항은 

- 재균형화 후  부하가 노드사이에 균등하게 분배
- 재균형화 도중에도 데이터베이스는 읽기/쓰기 요청을 받아들여야한다.
- 재균형화의 속도는 높아야하며 네트워크와 디스크 I/O 부하를 초소화할 수 있도록 노드들 사이에 데이터가 필요이상을 옮겨지면 안된다. 

데이터가 필요이상으로 움직이는  해시값에 모드 n 연산을 실행하는 것은 바람직하지 않다.( 노드 개수에 따라 대부분의 키가 움직여야하는 해시값에 모드 n연산은 데이터가 필요이상으로 움직인다.)



파티션의 개수를 고정하여 재균형화(개별파티션의 크기가 데이터셋크기 비례)

파티션의 개수를 고정으로 하는 것의 문제점을 바꾼 전체 데이터 용량에 맞춰 조정되는 동적 파티셔닝 (파티션개수와 데이터셋 크기 비례)

위 두방법의 파티션과 데이터 셋의 비례와 달리 노드당 할당되는 파티션 개수를 고정하는 노드 비례 파티셔닝 (파티션개수와 노드개수 비례)

방법이 있다 

 

위방법들의 완전 자동재균형화와 수동재균형화중에서 선택하여 할 수 있다 . 이는 관리자의 판단에 맏긴다 .

## 요청 라우팅

클라이언트에서 접속하여 요청을 보낼때 어떤 노드에 접속해야하는지에 대해서는 아직 산정한 바가 없다. 

서비스찾기의 일종이다. 

파티션 인지 로드 밸런서로 라우팅 결정을 내리는 구성요서가 노드에 할당된 파티션의 변경사항의 인지 문제를 가지고 주키퍼같은 별도의 코디네이션 서비스를 사용함을 통해 이를 해결하여 접근한다. 

또한 

병렬처리문제도있다 

분석용으로 자주사용되는 대규모 병렬처리 관계형데이터베이스 제품들에 있어서는 복잡한 종류의 질의를 지원하는데 조인 ,필터링, 그룹화 , 집계 연산을 몇개 포함하게된다. mpp(대규모 병렬처리 ) 는 10장에서 더 깊이 탐구할 것이다. 



